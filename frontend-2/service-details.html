<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>MİTHES</title>
  <meta name="description" content="" />
  <meta name="keywords" content="" />

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon" />
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Raleway:wght@300;400;500;600;700;800;900&family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
  <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet" />
</head>

<body class="index-page">
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="header-container container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex flex-column align-items-start me-auto me-xl-0">
        <h1 class="sitename">MİTHES</h1>
        <span class="logo-subtext">tracing & heating solution</span>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="#hero" class="active">Anasayfa</a></li>
          <li><a href="#about">Hakkımızda</a></li>
          <li class="dropdown"><a href="#portfolio"><span>Ürünlerimiz</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
            <ul>
              <li><a href="#">Varil Isıtıcılar</a></li>
              <li><a href="#">IBC Tank Isıtıcı</a></li>
              <li><a href="#">Esnek Boru Isıtıcıları / Isıtıcı Bantlar</a></li>
              <li><a href="#">İzolasyon Ceketleri</a></li>
              <li><a href="#">Özel İmalat Isıtıcı Ceketleri</a></li>
              <li><a href="#">Tüp Isıtıcı</a></li>
              <li><a href="#">Isıtıcı Kablolar</a></li>
              <li><a href="#">Sıcaklık Kontrol Cihazları</a></li>
              <li><a href="#">Bağlantı Kutuları</a></li>
              <li><a href="#">Bağlantı Kitleri</a></li>
            </ul>
          </li>
          <li><a href="#contact">İletişim</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <main class="main">
    <!-- Page Title -->
    <div class="page-title dark-background" data-aos="fade">
      <div class="container position-relative">
        <h1>Ürün Kataloğu</h1>
        <p>Kategori seçin, ürünleri inceleyin.</p>
        <nav class="breadcrumbs">
          <ol>
            <li><a href="index.html">Home</a></li>
            <li class="current">Ürünler</li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Ürün Kataloğu Section -->
    <section id="service-details" class="section py-5">
      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row gy-5">
          <!-- Kategoriler (Sol) -->
          <div class="col-lg-4 order-lg-1 order-2">
            <aside class="service-sidebar" data-aos="fade-right">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h3 class="mb-0">Kategoriler</h3>
                <button id="btn-reset" class="btn btn-sm btn-outline-secondary">Tümü</button>
              </div>
              <ul id="category-list" class="list-unstyled d-grid gap-2 category-list"></ul>

              <div class="action-card mt-4">
                <h4>Destek gerekir mi?</h4>
                <p>İhtiyacınıza en uygun ısıtıcıyı seçmeniz için yardımcı olalım.</p>
                <a href="/iletisim" class="btn-primary">Bize Ulaşın</a>
              </div>
            </aside>
          </div>

          <!-- Ürünler (Sağ) -->
          <div class="col-lg-8 order-lg-2 order-1">
            <div class="service-main-content">
              <header class="mb-4">
                <h1 id="category-title" class="mb-1">Tümü</h1>
                <p class="text-muted mb-0">Seçilen kategoriye ait ürünler listelenir.</p>
              </header>

              <!-- Ürün Grid -->
              <div id="product-grid" class="row g-4" data-aos="fade-up" data-aos-delay="150"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Basit stiller -->
      <style>
        .product-card .product-img { height: 180px; object-fit: cover; }
        .category-list .btn { background: transparent; border: 0; padding: .55rem .75rem; border-radius: .5rem; text-align: left; font-weight: 600; }
        .category-list .btn.active { background: var(--accent-color); color: var(--contrast-color); }
        .product-card .card-title { font-size: 1rem; }
        .spec-badge { cursor: pointer; }
      </style>

      <!-- Kategori & Ürün JS -->
      <script>
        // ==== API AYARLARI ====
        const API_BASE = (window.NEXT_PUBLIC_API_URL || '').replace(/\/+$/, '') || 'http://localhost:8080';
        const EP_PRODUCTS = API_BASE + '/api/products';
        const EP_CATEGORIES = API_BASE + '/api/categories';

        // ==== STATE ====
        let allProducts = [];
        let categories = [];
        let currentCategory = { id: null, name: 'Tümü' };

        // ==== HELPERS ====
        const trCur = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 });
        const esc = (s) => (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
        const priceText = (p) => {
          const min = p.minPrice ?? p.price ?? 0;
          const max = p.maxPrice ?? p.price ?? 0;
          if (min && max && min !== max) return `${trCur.format(min)} - ${trCur.format(max)}`;
          return trCur.format(min || max || 0);
        };

        // ==== DATA FETCH ====
        async function fetchCategories() {
          const res = await fetch(EP_CATEGORIES);
          const data = await res.json();
          return Array.isArray(data) ? data : [];
        }

        async function fetchAllProducts() {
          const res = await fetch(EP_PRODUCTS);
          const data = await res.json();
          return Array.isArray(data) ? data : [];
        }

        async function fetchProductsByCategoryId(catId) {
          // Tercih 1: /api/categories/{id}/products (önerilen)
          try {
            const res = await fetch(`${EP_CATEGORIES}/${catId}/products`);
            if (res.ok) {
              const data = await res.json();
              return Array.isArray(data) ? data : [];
            }
          } catch (_) { }

          // Tercih 2: /api/products?categoryId={id}
          try {
            const res = await fetch(`${EP_PRODUCTS}?categoryId=${encodeURIComponent(catId)}`);
            if (res.ok) {
              const data = await res.json();
              return Array.isArray(data) ? data : [];
            }
          } catch (_) { }

          // Fallback: eldeki üründen client-side filtre
          return allProducts.filter(p => p.category && p.category.id === catId);
        }

        // ==== RENDER ====
        function renderCategories(list) {
          const ul = document.getElementById('category-list');
          if (!ul) return;
          ul.innerHTML = list.map(c => `
            <li>
              <button type="button" class="btn w-100 ${currentCategory.id === c.id ? 'active' : ''}" data-id="${c.id}" data-name="${esc(c.name)}">
                ${esc(c.name)}
              </button>
            </li>
          `).join('');

          ul.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', async () => {
              ul.querySelectorAll('button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');

              currentCategory = { id: Number(btn.dataset.id), name: btn.dataset.name };
              document.getElementById('category-title').textContent = currentCategory.name;

              const items = await fetchProductsByCategoryId(currentCategory.id);
              renderProducts(items);
            });
          });
        }

        function technicalSpecsHTML(p) {
          const specs = p.technicalSpecs || p.specs || {};
          const keys = Object.keys(specs);
          if (!keys.length) return '';
          return `
            <div class="mt-2 d-flex flex-wrap gap-1">
              ${keys.slice(0, 4).map(k => `<span class="badge bg-light text-dark border spec-badge" title="${esc(k)}: ${esc(specs[k])}">${esc(k)}: ${esc(String(specs[k]).slice(0, 14))}${String(specs[k]).length > 14 ? '…' : ''}</span>`).join('')}
            </div>
          `;
        }

        function detailHref(id) {
          const safeId = id ?? '';
          return `portfolio-details.html?id=${encodeURIComponent(safeId)}`;
        }

        function renderProducts(items) {
          const grid = document.getElementById('product-grid');
          if (!grid) return;

          grid.innerHTML = (items || []).map(p => `
            <div class="col-sm-6 col-lg-4">
              <div class="card h-100 shadow-sm product-card">
                <a href="${detailHref(p.id)}" class="d-block">
                  <img src="${p.imageUrl || '/assets/img/placeholder.webp'}" class="card-img-top product-img" alt="${esc(p.name)}" />
                </a>
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title mb-1">
                    <a href="${detailHref(p.id)}" class="stretched-link text-decoration-none text-dark">${esc(p.name)}</a>
                  </h5>
                  ${p.category?.name ? `<div class="small text-muted mb-1"><span class="badge bg-secondary">${esc(p.category.name)}</span></div>` : ''}
                  <div class="fw-semibold mb-2">${priceText(p)}</div>
                  <p class="card-text flex-grow-1">${esc((p.description || '').slice(0, 140))}${(p.description || '').length > 140 ? '…' : ''}</p>
                  ${technicalSpecsHTML(p)}
                  <div class="mt-3 d-grid gap-2 position-relative" style="z-index:1">
                    <a href="${detailHref(p.id)}" class="btn btn-outline-primary">İncele</a>
                    <button class="btn btn-primary" data-action="select" data-id="${p.id}">Seç</button>
                  </div>
                </div>
              </div>
            </div>
          `).join('') || `<div class="col-12"><div class="alert alert-warning">Bu kategoride ürün bulunamadı.</div></div>`;

          // Seç butonları
          grid.querySelectorAll('button[data-action="select"]').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.getAttribute('data-id');
              // Burada sepet veya talep formu akışına bağlayabilirsin
              alert(`Ürün seçildi: #${id}`);
            });
          });
        }

        // ==== INIT ====
        (async function init() {
          try {
            // Verileri topla
            [categories, allProducts] = await Promise.all([
              fetchCategories(),
              fetchAllProducts(),
            ]);

            // Kategorileri göster
            renderCategories(categories);

            // Başlangıçta Tümü
            document.getElementById('btn-reset').addEventListener('click', async () => {
              currentCategory = { id: null, name: 'Tümü' };
              document.getElementById('category-title').textContent = 'Tümü';
              document.querySelectorAll('#category-list .btn').forEach(b => b.classList.remove('active'));
              renderProducts(allProducts);
            });

            renderProducts(allProducts);
          } catch (e) {
            console.error(e);
            renderCategories([]);
            renderProducts([]);
          }
        })();
      </script>
    </section>
  </main>

  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-about">
          <a href="index.html" class="logo d-flex align-items-center">
            <span class="sitename">Mithes</span>
          </a>
          <p>
            Mithes, endüstriyel ısıtma çözümlerinde uzmanlaşmış, yüksek kaliteli varil ısıtıcıları,
            IBC tank ısıtıcıları, esnek boru ısıtıcıları ve izolasyon ceketleri sunan güvenilir bir markadır.
          </p>
          <div class="social-links d-flex mt-4">
            <a href="https://twitter.com/mithes" target="_blank" rel="noopener"><i class="bi bi-twitter"></i></a>
            <a href="https://www.facebook.com/mithes" target="_blank" rel="noopener"><i class="bi bi-facebook"></i></a>
            <a href="https://www.instagram.com/mithes" target="_blank" rel="noopener"><i class="bi bi-instagram"></i></a>
            <a href="https://www.linkedin.com/company/mithes" target="_blank" rel="noopener"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>

        <div class="col-lg-2 col-6 footer-links">
          <h4>Hızlı Linkler</h4>
          <ul>
            <li><a href="index.html">Anasayfa</a></li>
            <li><a href="about.html">Hakkımızda</a></li>
            <li><a href="products.html">Ürünler</a></li>
            <li><a href="contact.html">İletişim</a></li>
            <li><a href="privacy.html">Gizlilik Politikası</a></li>
          </ul>
        </div>

        <div class="col-lg-2 col-6 footer-links">
          <h4>Ürün Kategorileri</h4>
          <ul>
            <li><a href="products.html#varil-isiticilar">Varil Isıtıcılar</a></li>
            <li><a href="products.html#ibc-tank-isiticilar">IBC Tank Isıtıcı</a></li>
            <li><a href="products.html#boru-isiticilar">Esnek Boru Isıtıcıları</a></li>
            <li><a href="products.html#izolasyon-ceketleri">İzolasyon Ceketleri</a></li>
            <li><a href="products.html#ozel-imalat">Özel İmalat Ceketler</a></li>
          </ul>
        </div>

        <div class="col-lg-3 col-md-12 footer-contact text-center text-md-start">
          <h4>İletişim</h4>
          <p>Soğanlık Yeni Mah. Pegagaz Sok. Pega Kartal Residence D.3</p>
          <p>İstanbul, Türkiye</p>
          <p>
            <strong>Telefon:</strong> <span>+90 216 523 49 00</span><br />
            <strong>Email:</strong> <span>info@mithes.com</span>
          </p>
        </div>
      </div>
    </div>

    <div class="container copyright text-center mt-4">
      <p>© <span>2025</span> <strong class="px-1 sitename">Mithes</strong>. Tüm Hakları Saklıdır.</p>
      <div class="credits">
        Designed by <a href="https://tyonex.com.tr/" target="_blank" rel="noopener">TYONEX</a>
      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>
</body>

</html>
