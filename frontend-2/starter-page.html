<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MİTHES — Sepet & Teklif</title>
  <meta name="description" content="MİTHES sipariş sepeti ve teklif talep sayfası." />
  <link rel="canonical" href="/cart.html" />

  <!-- DEV/TEST için backend hostunu sabitle -->
  <meta name="api-base" content="http://localhost:8080">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon" />
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Raleway:wght@400;500;600;700;800;900&family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Vendor CSS -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
  <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />

  <!-- Main CSS -->
  <link href="assets/css/main.css" rel="stylesheet" />

  <style>
    :root { --mithes-surface: var(--surface-color, #101010); --mithes-border: var(--border-color, #2c2c2c); }
    body.index-page { background-color: var(--dark-background, #0b0b0b); }
    .logo-subtext { font-size: .8rem; letter-spacing: .03em; opacity: .8; }
    .cart-icon .badge { font-size: .65rem; }
    .page-title { padding: 6rem 0 2rem; }
    .page-title .breadcrumbs ol { margin: 0; }
    .list-product-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: .5rem; }
    .list-group-item.mithes-item { background-color: var(--mithes-surface); color: var(--default-color); border-color: var(--mithes-border); }
    .btn-outline-accent { border-color: var(--accent-color); color: var(--accent-color); }
    .btn-outline-accent:hover { background: var(--accent-color); color: var(--contrast-color); }
    .card.mithes-panel { background-color: var(--mithes-surface); border-color: var(--mithes-border); color: var(--default-color); }
    .form-control, .form-select, .form-check-input { background: var(--background-color, #fff); color: var(--default-color, #111); border-color: var(--mithes-border); }
    .btn-accent { background: var(--accent-color); color: var(--contrast-color); }
    .btn-accent:hover { filter: brightness(.9); }
    .empty-cart { font-style: italic; opacity: .9; }
  </style>
</head>

<body class="index-page">
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="header-container container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex flex-column align-items-start me-auto me-xl-0 text-decoration-none">
        <h1 class="sitename m-0">MİTHES</h1>
        <span class="logo-subtext">tracing & heating solution</span>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="#hero" class="active">Anasayfa</a></li>
          <li><a href="#about">Hakkımızda</a></li>
          <li class="dropdown">
            <a href="#portfolio"><span>Ürünlerimiz</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
            <ul>
              <li><a href="#">Varil Isıtıcılar</a></li>
              <li><a href="#">IBC Tank Isıtıcı</a></li>
              <li><a href="#">Esnek Boru Isıtıcıları / Isıtıcı Bantlar</a></li>
              <li><a href="#">İzolasyon Ceketleri</a></li>
              <li><a href="#">Özel İmalat Isıtıcı Ceketleri</a></li>
              <li><a href="#">Tüp Isıtıcı</a></li>
              <li><a href="#">Isıtıcı Kablolar</a></li>
              <li><a href="#">Sıcaklık Kontrol Cihazları</a></li>
              <li><a href="#">Bağlantı Kutuları</a></li>
              <li><a href="#">Bağlantı Kitleri</a></li>
            </ul>
          </li>
          <li><a href="#contact">İletişim</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list" aria-label="Menüyü aç/kapat"></i>
      </nav>

      <a href="#cart" class="cart-icon ms-3 position-relative" aria-label="Sepet">
        <i class="bi bi-cart3 fs-4"></i>
        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
      </a>
    </div>
  </header>

  <main class="main">
    <section class="page-title dark-background" data-aos="fade">
      <div class="container position-relative">
        <h1>Sepetiniz &amp; Teklif İste</h1>
        <p>Sepetinizdeki ürünleri görüntüleyin ve teklif göndermek için formu doldurun.</p>
        <nav class="breadcrumbs" aria-label="breadcrumb">
          <ol>
            <li><a href="index.html">Anasayfa</a></li>
            <li class="current" aria-current="page">Sepet</li>
          </ol>
        </nav>
      </div>
    </section>

    <section id="cart" class="section dark-background py-4">
      <div class="container text-body">
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card mithes-panel shadow-sm">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h4 m-0">Sepetiniz</h2>
                <button id="clear-cart" class="btn btn-sm btn-outline-accent"><i class="bi bi-trash3 me-1"></i>Sepeti Temizle</button>
              </div>
              <div class="card-body">
                <div id="cart-loading" class="d-flex align-items-center gap-2">
                  <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                  <span>Ürünler yükleniyor…</span>
                </div>
                <ul id="cart-items-list" class="list-group list-group-flush d-none" aria-live="polite"></ul>
                <p id="cart-empty" class="empty-cart d-none">Sepetiniz boş.</p>
              </div>
              <div class="card-footer d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <div><span class="fw-semibold">Ara Toplam:</span> <span id="cart-subtotal" class="ms-2">0 ₺</span></div>
                <div><span class="fw-semibold">Toplam Adet:</span> <span id="cart-qty" class="ms-2">0</span></div>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card mithes-panel shadow-sm">
              <div class="card-body">
                <h3 class="h5 text-center mb-3">Kullanıcı Bilgileri</h3>
                <form id="order-form" class="needs-validation" novalidate>
                  <div class="mb-3">
                    <label for="name" class="form-label">Adınız<span class="text-danger"> *</span></label>
                    <input type="text" id="name" name="name" class="form-control" placeholder="Adınız" required />
                    <div class="invalid-feedback">Lütfen adınızı girin.</div>
                  </div>
                  <div class="mb-3">
                    <label for="companyName" class="form-label">Firma Adı</label>
                    <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Firma Adı (opsiyonel)" />
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">E-posta<span class="text-danger"> *</span></label>
                    <input type="email" id="email" name="email" class="form-control" placeholder="mail@ornek.com" inputmode="email" required />
                    <div class="invalid-feedback">Geçerli bir e-posta girin.</div>
                  </div>
                  <div class="mb-3">
                    <label for="phone" class="form-label">Telefon<span class="text-danger"> *</span></label>
                    <input type="tel" id="phone" name="phone" class="form-control" placeholder="05xx xxx xx xx" inputmode="tel" pattern="^(\+?90)?\s?0?5\d{2}\s?\d{3}\s?\d{2}\s?\d{2}$" required />
                    <div class="form-text">Örnek: 05xx xxx xx xx</div>
                    <div class="invalid-feedback">Geçerli bir telefon numarası girin.</div>
                  </div>
                  <div class="mb-3">
                    <label for="message" class="form-label">Mesajınız (Opsiyonel)</label>
                    <textarea id="message" name="message" class="form-control" rows="4" placeholder="İstek/Not…"></textarea>
                  </div>
                  <button type="submit" id="submit-offer" class="btn btn-accent w-100">
                    <span class="submit-label"><i class="bi bi-send me-1"></i>Teklifi Gönder</span>
                    <span class="submit-spinner d-none align-middle"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Gönderiliyor…</span>
                  </button>
                </form>
                <div id="form-disabled-note" class="alert alert-warning mt-3 d-none" role="alert">
                  Sepet boş olduğu için form devre dışı.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-about">
          <a href="index.html" class="logo d-flex align-items-center text-decoration-none">
            <span class="sitename">MİTHES</span>
          </a>
          <p>Endüstriyel ısıtma çözümleri ve teknoloji odaklı üretim desteği. İhtiyacınıza uygun çözüm için bizimle iletişime geçin.</p>
          <div class="social-links d-flex mt-4">
            <a href="#" aria-label="X"><i class="bi bi-twitter-x"></i></a>
            <a href="#" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
            <a href="#" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
            <a href="#" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>

        <div class="col-lg-2 col-6 footer-links">
          <h4>Bağlantılar</h4>
          <ul>
            <li><a href="#hero">Anasayfa</a></li>
            <li><a href="#about">Hakkımızda</a></li>
            <li><a href="#portfolio">Ürünler</a></li>
            <li><a href="#">Kullanım Şartları</a></li>
            <li><a href="#">Gizlilik</a></li>
          </ul>
        </div>

        <div class="col-lg-2 col-6 footer-links">
          <h4>Hizmetler</h4>
          <ul>
            <li><a href="#">Endüstriyel Isıtma</a></li>
            <li><a href="#">Özel İmalat</a></li>
            <li><a href="#">Teknik Danışmanlık</a></li>
            <li><a href="#">Ar-Ge</a></li>
            <li><a href="#">Bakım &amp; Destek</a></li>
          </ul>
        </div>

        <div class="col-lg-3 col-md-12 footer-contact text-center text-md-start">
          <h4>İletişim</h4>
          <p>Soğanlık Yeni Mah. Pegagaz Sok.Pega Kartal Residence D.3</p>
          <p>İstanbul, Türkiye</p>
          <p><strong>Telefon:</strong> <span>+90 216 523 49 00</span><br>
             <strong>Email:</strong> <span>info@mithes.com</span></p>
        </div>
      </div>
    </div>

    <div class="container copyright text-center mt-4">
      <p>© <span>Copyright</span> <strong class="px-1 sitename">MİTHES</strong> <span>Tüm Hakları Saklıdır</span></p>
      <div class="credits">Designed by <a href="https://tyonex.com.tr/">TYONEX</a></div>
    </div>
  </footer>

  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center" aria-label="Yukarı dön"><i class="bi bi-arrow-up-short"></i></a>
  <div id="preloader" class="d-none"></div>

  <!-- Vendor JS -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>

  <!-- Main JS -->
  <script src="assets/js/main.js"></script>

  <!-- Cart Logic -->
  <script>
  (() => {
    const cartItemsList = document.getElementById('cart-items-list');
    const cartLoading   = document.getElementById('cart-loading');
    const cartEmpty     = document.getElementById('cart-empty');
    const subtotalEl    = document.getElementById('cart-subtotal');
    const qtyEl         = document.getElementById('cart-qty');
    const cartCountBadge= document.getElementById('cart-count');
    const clearCartBtn  = document.getElementById('clear-cart');

    const form             = document.getElementById('order-form');
    const formDisabledNote = document.getElementById('form-disabled-note');
    const submitBtn        = document.getElementById('submit-offer');
    const submitLabel      = submitBtn.querySelector('.submit-label');
    const submitSpinner    = submitBtn.querySelector('.submit-spinner');

    const TRYFmt = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' });

    // API base (meta > fallback)
    const API_BASE = (document.querySelector('meta[name="api-base"]')?.content || '').trim()
                  || ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:8080' : '');

    const absUrl = (u) => {
      if (!u) return '';
      if (/^https?:\/\//i.test(u)) return u;
      return u.startsWith('/') ? API_BASE + u : API_BASE + '/' + u;
    };

    const getCart = () => { try { return JSON.parse(localStorage.getItem('cart')) || []; } catch { return []; } };
    const setCart = (c) => localStorage.setItem('cart', JSON.stringify(c));

    const updateBadge = (q) => {
      if (q > 0) { cartCountBadge.textContent = String(q); cartCountBadge.classList.remove('d-none'); }
      else cartCountBadge.classList.add('d-none');
    };

    const totals = (items) => {
      const subtotal = items.reduce((a,p)=>a+(+p.price||0)*(+p.quantity||0),0);
      const qty = items.reduce((a,p)=>a+(+p.quantity||0),0);
      subtotalEl.textContent = TRYFmt.format(subtotal);
      qtyEl.textContent = String(qty);
      updateBadge(qty);
    };

    const renderEmpty = () => {
      cartLoading.classList.add('d-none');
      cartItemsList.classList.add('d-none');
      cartEmpty.classList.remove('d-none');
      form.classList.add('d-none');
      formDisabledNote.classList.remove('d-none');
    };

    const renderItems = (products) => {
      cartItemsList.innerHTML = '';
      products.forEach((p) => {
        const li = document.createElement('li');
        li.className = 'list-group-item mithes-item py-3';

        const img = p.imageUrl ? `<img class="list-product-thumb" src="${absUrl(p.imageUrl)}" alt="${p.name}" onerror="this.style.display='none'">` : '';

        li.innerHTML = `
          <div class="d-flex align-items-center gap-3">
            ${img}
            <div class="flex-grow-1">
              <h4 class="h6 mb-1">${p.name || ('Ürün #' + p.id)}</h4>
              <div class="small opacity-75">Adet: <strong>${p.quantity}</strong></div>
              <div class="fw-semibold mt-1">${TRYFmt.format((+p.price||0) * (+p.quantity||0))}</div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" data-action="dec" aria-label="Adeti azalt">–</button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-action="inc" aria-label="Adeti artır">+</button>
              <button type="button" class="btn btn-sm btn-outline-accent" data-action="remove" aria-label="Kaldır"><i class="bi bi-x-lg"></i></button>
            </div>
          </div>`;

        li.querySelector('[data-action="remove"]').addEventListener('click', () => {
          const cart = getCart().filter(ci => String(ci.id) !== String(p.id));
          setCart(cart);
          li.remove();
          if (!cart.length) renderEmpty(); else totals(cart.map(x=>({ ...x })));
        });

        li.querySelector('[data-action="inc"]').addEventListener('click', () => {
          const cart = getCart();
          const found = cart.find(ci => String(ci.id) === String(p.id));
          if (found) { found.quantity = (+found.quantity||0)+1; setCart(cart); location.reload(); }
        });

        li.querySelector('[data-action="dec"]').addEventListener('click', () => {
          const cart = getCart();
          const found = cart.find(ci => String(ci.id) === String(p.id));
          if (found) { found.quantity = Math.max(1,(+found.quantity||1)-1); setCart(cart); location.reload(); }
        });

        cartItemsList.appendChild(li);
      });

      cartLoading.classList.add('d-none');
      cartEmpty.classList.add('d-none');
      cartItemsList.classList.remove('d-none');
      form.classList.remove('d-none');
      formDisabledNote.classList.add('d-none');
    };

    async function loadProducts() {
      const cart = getCart();
      if (!cart.length) { renderEmpty(); return; }

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 15000);

      try {
        const products = await Promise.all(cart.map(async (item) => {
          // Eğer localStorage'da ürün adı/görsel de saklıyorsan, fetch başarısız olursa fallback yapıyoruz
          const fallback = { id: item.id, name: item.name, imageUrl: item.imageUrl, price: item.price, quantity: item.quantity };

          try {
            const res = await fetch(`${API_BASE}/api/products/${encodeURIComponent(item.id)}`, {
              signal: controller.signal, headers: { 'Accept': 'application/json' }
            });
            if (!res.ok) return fallback; // 404 vs: local veriyi kullan
            const data = await res.json().catch(() => ({}));
            return { ...data, quantity: Number(item.quantity)||1 };
          } catch {
            return fallback;
          }
        }));

        renderItems(products);
        totals(products);
      } catch (err) {
        console.error(err);
        cartLoading.innerHTML = `<span class="text-danger">${err?.message || 'Ürünler yüklenemedi.'}</span>`;
      } finally {
        clearTimeout(timeout);
      }
    }

    clearCartBtn.addEventListener('click', () => {
      localStorage.removeItem('cart');
      renderEmpty();
      totals([]);
    });

    // Teklif formu
    (function setupForm(){
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.classList.add('was-validated'); return; }

        const cart = getCart();
        if (!cart.length) { renderEmpty(); return; }

        const payload = {
          name: form.name.value.trim(),
          companyName: form.companyName.value.trim(),
          email: form.email.value.trim(),
          phone: form.phone.value.trim(),
          message: form.message.value.trim(),
          products: cart.map(ci => ({ productId: ci.id, quantity: Number(ci.quantity)||1 }))
        };

        submitBtn.disabled = true;
        submitLabel.classList.add('d-none');
        submitSpinner.classList.remove('d-none');

        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 20000);

        try {
          const res = await fetch(`${API_BASE}/api/offer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'text/plain, application/json' },
            body: JSON.stringify(payload),
            signal: controller.signal
          });
          if (!res.ok) throw new Error(await res.text() || 'Teklif gönderilemedi.');
          alert((await res.text()) || 'Talebiniz alınmıştır.');
          localStorage.removeItem('cart');
          location.href = 'index.html';
        } catch (err) {
          console.error(err);
          alert(err.message || 'Bir hata oluştu.');
        } finally {
          clearTimeout(timeout);
          submitBtn.disabled = false;
          submitLabel.classList.remove('d-none');
          submitSpinner.classList.add('d-none');
        }
      });
    })();

    loadProducts();
  })();
  </script>
</body>
</html>
